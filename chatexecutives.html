<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Equity Crew '26 | Elite Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <style>
        :root {
            --gold: #826c24; --emerald: #064e3b; --deep-green: #022c22;
            --glass: rgba(2, 44, 34, 0.98); --border: rgba(212, 175, 55, 0.2); --crimson: #ef4444;
        }

        * {cursor: pointer; margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif ; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: #022c22; color: white; min-height: 100vh; padding-bottom: 90px;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .cambria { font-family: 'Poppins', serif; }

        /* Gallery */
        .gallery-wrapper { position: relative; display: flex; align-items: center; margin: 20px 0; }
        .faculty-gallery { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 15px; padding: 10px; scrollbar-width: none; width: 100%; }
        .faculty-gallery::-webkit-scrollbar { display: none; }
        .member-card { min-width: 240px; background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid var(--border); }
        .member-image { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold); margin-bottom: 10px; }
        
        /* Components */
        .elite-card { background: rgba(255, 255, 255, 0.04); border-radius: 20px; border: 1px solid var(--border); padding: 15px; margin-bottom: 15px; }
        .btn-luxury { padding: 12px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--gold), #b08d29); color: #022c22; font-weight: 800; cursor: pointer; font-size: 0.7rem; text-transform: uppercase; width: 100%; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; outline: none; }
        .post-media { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass); display: flex; justify-content: space-around; padding: 12px 10px 25px; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-link { color: #777; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-link.active { color: var(--gold); }
        .exec-badge { background: var(--gold); color: rgb(44, 45, 4); font-size:0.6rem; padding: 4px 6px; border-radius: 4px; font-weight: 800; }
        
        #chat-drawer { position: fixed; inset: 0; background: #021a14; z-index: 2000; display: flex; flex-direction: column; }
        .chat-bubble { padding: 10px 14px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 0.85rem; }
        .sent { align-self: flex-end; background: var(--gold); color: black; }
        .received { align-self: flex-start; background: rgba(255,255,255,0.1); }

        .price-tag { background: var(--gold); color: black; font-weight: 800; font-size: 0.7rem; padding: 2px 8px; border-radius: 5px; }

        .comment-vault { max-height: 120px; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        .comment-item { font-size: 0.7rem; margin-bottom: 6px; background: rgba(255, 255, 255, 0.03); padding: 8px; border-radius: 8px; border-left: 2px solid var(--border); }

        .membership-card {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(2, 44, 34, 0.8) 100%);
            border: 1px solid var(--gold); border-radius: 25px; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .profile-stats-container { display: flex; justify-content: space-around; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(212, 175, 55, 0.2); }
        .stat-number { display: block; font-size: 1.4rem; font-weight: 800; color: var(--gold); }
        .stat-label { font-size: 0.5rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; }

        .action-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        
        #public-profile-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

<div id="auth-screen" class="container" style="padding-top: 50px;">
    <div class="elite-card" style="text-align:center;">
        <h1 class="cambria" style="color:var(--gold); font-size: 2.2rem;"> EQUITY 2026</h1>
        <div id="auth-choice">
            <button class="btn-luxury" style="margin-top:20px;" onclick="showReg()">Student Entrance</button>
            <button class="btn-luxury" style="margin-top:10px; background:transparent; color:var(--gold); border:1px solid var(--gold);" onclick="gate()">Executive Portal</button>
        </div>
        <div id="reg-form" class="hidden" style="margin-top: 20px;">
            <input type="text" id="reg-name" class="form-input" placeholder="Full Name">
            <input type="text" id="reg-matric" class="form-input" placeholder="Matric No">
            <button class="btn-luxury" id="auth-submit-btn" onclick="handleAuth()">Access Hub</button>
            <p onclick="location.reload()" style="font-size:0.7rem; margin-top:15px; cursor:pointer; opacity:0.5;">‚Üê Back</p>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <header style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--glass); position: sticky; top:0; z-index: 100;">
        <div class="cambria" style="color:var(--gold); font-weight:900;"> STUDENT HUB</div>
        <img id="u-pfp" style="width:32px; height:32px; border-radius:50%; border:1.5px solid var(--gold);">
    </header>

    <div class="container">
        <section id="tab-market" class="hidden">
            <div class="elite-card">
                <h3 class="cambria" style="color:var(--gold); margin-bottom:5px;">Marketplace</h3>
                <input type="text" id="market-item-name" class="form-input" placeholder="What are you selling?">
                <input type="number" id="market-item-price" class="form-input" placeholder="Price (‚Ç¶)">
                <textarea id="market-item-desc" class="form-input" placeholder="Short description..." style="height:60px; resize:none;"></textarea>
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <label style="cursor:pointer; color:var(--gold); font-size:0.7rem;">
                        <i data-lucide="camera" style="width:16px; vertical-align:middle;"></i> Add Photo
                        <input type="file" id="market-file-input" class="hidden" accept="image/*" onchange="handleMarketFile(this)">
                    </label>
                    <button class="btn-luxury" style="width:auto; padding: 5px 20px;" onclick="publishMarketItem()">List Item</button>
                </div>
                <div id="market-progress" style="font-size:0.6rem; margin-top:5px; color:var(--gold);"></div>
            </div>
            <div id="market-display" style="display: grid; grid-template-columns: 1fr; gap: 15px;"></div>
        </section>

        <section id="tab-feed">
            <div class="gallery-wrapper">
                <button onclick="sideScroll('left')" style="position: absolute; left: -10px; z-index: 10; background: var(--gold); border: none; border-radius: 50%; width: 30px; height: 30px;">&#10094;</button>
                <div class="faculty-gallery" id="exec-gallery"></div>
                <button onclick="sideScroll('right')" style="position: absolute; right: -10px; z-index: 10; background: var(--gold); border: none; border-radius: 50%; width: 30px; height: 30px;">&#10095;</button>
            </div>
            <div class="elite-card">
                <textarea id="post-text" class="form-input" placeholder="Post an update..." style="height:60px; resize:none;"></textarea>
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <label style="cursor:pointer; color:var(--gold);"><i data-lucide="paperclip"></i>
                        <input type="file" id="post-file" class="hidden" accept="image/*" onchange="handleFile(this)">
                    </label>
                    <button class="btn-luxury" id="post-btn" style="width:auto; padding: 5px 20px;" onclick="publishPost()">Post</button>
                </div>
                <div id="upload-progress" style="font-size:0.6rem; margin-top:5px; color:var(--gold);"></div>
            </div>
            <div id="feed-display"></div>
        </section>

        <section id="tab-gp" class="hidden">
            <div class="elite-card">
                <h3 class="cambria" style="color: var(--gold); text-align: center;">4.0 GP Calculator</h3>
                <div id="course-list" style="margin-top:15px;"></div>
                <button class="btn-luxury" style="background: transparent; border: 1px solid var(--gold); color: var(--gold); margin: 10px 0;" onclick="addCourseRow()">+ Add Course</button>
                <div style="margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(0,0,0,0.4); text-align: center; border: 1.5px solid var(--gold);">
                    <h1 id="gp-res" style="color: var(--gold); font-size: 2.2rem; margin:0;">0.00</h1>
                </div>
                <button class="btn-luxury" style="margin-top: 15px;" onclick="calculateGP()">Calculate & Save</button>
            </div>
        </section>

        <section id="tab-chat" class="hidden">
            <h3 class="cambria" style="color:var(--gold); margin-bottom:15px;">Direct Messages</h3>
            <div id="chat-list"></div>
        </section>

        <section id="tab-profile" class="hidden">
            <div class="membership-card">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <p style="font-size: 0.5rem; letter-spacing: 3px; color: var(--gold);">OFFICIAL MEMBER</p>
                        <h2 id="p-name" class="cambria"></h2>
                        <span id="p-role" class="exec-badge"></span>
                    </div>
                    <img id="p-img" style="width: 80px; height: 80px; border-radius: 20px; border: 2px solid var(--gold); object-fit: cover;">
                </div>
                <p id="p-matric-display" style="margin-top:15px; font-family: monospace; opacity: 0.7;"></p>
                <div class="profile-stats-container">
                    <div class="stat-item"><span class="stat-number" id="stat-posts">0</span><span class="stat-label">Posts</span></div>
                    <div class="stat-item"><span class="stat-number" id="stat-gp">0.00</span><span class="stat-label">GPA</span></div>
                </div>
            </div>
            <div style="margin-top: 25px;">
                <div class="action-item" onclick="logout()" style="border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
                    <span>Logout Session</span><i data-lucide="power"></i>
                </div>
            </div>
        </section>
    </div>

    <nav class="bottom-nav">
        <div class="nav-link active" onclick="switchTab('feed')"><i data-lucide="home"></i><small>Feed</small></div>
        <div class="nav-link" onclick="switchTab('market')"><i data-lucide="shopping-bag"></i><small>Market</small></div>
        <div class="nav-link" onclick="switchTab('gp')"><i data-lucide="calculator"></i><small>GP</small></div>
        <div class="nav-link" onclick="switchTab('chat')"><i data-lucide="message-circle"></i><small>Chat</small></div>
        <div class="nav-link" onclick="switchTab('profile')"><i data-lucide="user"></i><small>Profile</small></div>
    </nav>
</div>

<div id="chat-drawer" class="hidden">
    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background: var(--glass);">
        <b id="chat-target" class="cambria" style="color:var(--gold);"></b>
        <i data-lucide="x" onclick="closeChat()"></i>
    </div>
    <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
    <div style="padding:15px; display:flex; gap:10px; border-top: 1px solid var(--border);">
        <input type="text" id="msg-input" class="form-input" style="margin:0;" placeholder="Message..." onkeypress="if(event.key==='Enter') sendMsg()">
        <button class="btn-luxury" style="width:auto; padding:10px 15px;" onclick="sendMsg()"><i data-lucide="send"></i></button>
    </div>
</div>

<div id="public-profile-modal" class="hidden">
    <div class="elite-card" style="width: 100%; max-width: 350px; text-align: center;">
        <img id="view-p-img" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--gold);">
        <h2 id="view-p-name" class="cambria" style="margin-top:10px;"></h2>
        <p id="view-p-role" class="exec-badge" style="display:inline-block;"></p>
        <p id="view-p-matric" style="margin:10px 0; opacity:0.6;"></p>
        <button id="view-p-chat-btn" class="btn-luxury">Send Message</button>
        <button class="btn-luxury" style="background:transparent; color:white; border:1px solid var(--border); margin-top:10px;" onclick="closePublicProfile()">Close</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBLrdBzHOhsJW4_ixghTx96XpHT4QMS8s8",
        authDomain: "executo-4ecd7.firebaseapp.com",
        projectId: "executo-4ecd7",
        storageBucket: "executo-4ecd7.firebasestorage.app",
        messagingSenderId: "738758706005",
        appId: "1:738758706005:web:383f547ce4ddb8b243e5dc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let user = JSON.parse(localStorage.getItem('ec26_user'));
    let isExecLogin = false;
    let verifiedMediaUrl = "";
    let activeChatId = null;
    let activeChatListener = null;

    const EXECS = [
        { name: "Ajiferuke Ridwanullahi", role: "President", key: "PREZ26-AJ", pka: "AJII", img: "ajii.jpg", quote: "Leadership is the standard." },
        { name: "Olaniyan Kehinde", role: "Vice President", key: "VP26-AR", pka: "ARMANI", img: "armani.jpg", quote: "Accuracy is our mandate." },
        { name: "Obidare Ibrahim", role: "General Secretary", key: "SEC26-IB", pka: "AJII", img: "dolapo.JPG", quote: "Organization is greatness." },
        { name: "Oyebode Blessing", role: "Financial Secretary", key: "FIN26-BL", pka: "IRON LADY", img: "oyenike.JPG", quote: "Integrity is key." }
    ];

    window.onload = () => { 
        if(user) showApp(); 
        addCourseRow(); 
        lucide.createIcons(); 
    };

    function gate() { 
        const pass = prompt("Enter Executive Access Key:");
        const foundExec = EXECS.find(e => e.key === pass);
        if(foundExec) { 
            isExecLogin = true; 
            document.getElementById('reg-name').value = foundExec.name;
            showReg(); 
        } else alert("Invalid Key");
    }

    function showReg() {
        document.getElementById('auth-choice').classList.add('hidden');
        document.getElementById('reg-form').classList.remove('hidden');
    }

    async function handleAuth() {
        const n = document.getElementById('reg-name').value.trim();
        const m = document.getElementById('reg-matric').value.trim().toUpperCase();
        if(!n || !m) return alert("Fill all fields");
        
        const userData = { 
            id: "U" + Date.now(), name: n, matric: m, isExec: isExecLogin, 
            pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`, 
            role: isExecLogin ? "Executive" : "Student" 
        };
        
        await db.collection("users").doc(userData.id).set(userData);
        localStorage.setItem('ec26_user', JSON.stringify(userData));
        user = userData;
        showApp();
    }

    function showApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('u-pfp').src = user.pic;
        renderGallery(); 
        renderFeed(); 
        renderChatList();
        renderMarketplace();
    }

    function renderGallery() {
        document.getElementById('exec-gallery').innerHTML = EXECS.map(e => `
            <div class="member-card">
                <img src="${e.img}" class="member-image" onerror="this.src='https://via.placeholder.com/80'">
                <p class="exec-badge">${e.role}</p>
                <h4 class="cambria">${e.name}</h4>
                <p style="font-size:0.6rem; opacity:0.6;">"${e.quote}"</p>
            </div>
        `).join('');
    }

    function sideScroll(dir) { document.getElementById('exec-gallery').scrollLeft += (dir === 'left' ? -250 : 250); }

    function handleFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => { 
            verifiedMediaUrl = e.target.result;
            document.getElementById('upload-progress').innerText = "‚úÖ Ready";
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function publishPost() {
        if(!document.getElementById('post-text').value && !verifiedMediaUrl) return;
        await db.collection("posts").add({
            uid: user.id, name: user.name, role: user.role, pic: user.pic,
            txt: document.getElementById('post-text').value, file: verifiedMediaUrl, 
            likes: [], comments: [], time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('post-text').value = "";
        verifiedMediaUrl = "";
        document.getElementById('upload-progress').innerText = "";
    }

    function renderFeed() {
        db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
            const f = document.getElementById('feed-display');
            f.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                f.innerHTML += `
                    <div class="elite-card">
                        <div style="display:flex; gap:10px; align-items:center;" onclick="openPublicProfile('${d.uid}')">
                            <img src="${d.pic}" style="width:30px; height:30px; border-radius:50%;">
                            <b style="font-size:0.8rem;">${d.name} <span class="exec-badge">${d.role}</span></b>
                        </div>
                        <p style="margin:10px 0; font-size:0.9rem;">${d.txt}</p>
                        ${d.file ? `<img src="${d.file}" class="post-media">` : ''}
                        <div style="margin-top:10px; display:flex; gap:15px; font-size:0.7rem;">
                            <span onclick="likePost('${doc.id}')">‚ù§ ${d.likes.length}</span>
                            <span>üí¨ ${d.comments.length}</span>
                        </div>
                        <div class="comment-vault">
                            ${d.comments.map(c => `<div class="comment-item"><b>${c.userName}:</b> ${c.text}</div>`).join('')}
                        </div>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input id="in-${doc.id}" class="form-input" style="margin:0; font-size:0.7rem;" placeholder="Comment...">
                            <button onclick="sendComment('${doc.id}')" style="background:none; border:none; color:var(--gold);"><i data-lucide="send" style="width:16px;"></i></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        });
    }

    async function likePost(id) {
        const ref = db.collection("posts").doc(id);
        const doc = await ref.get();
        const likes = doc.data().likes || [];
        if(likes.includes(user.id)) await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(user.id) });
        else await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(user.id) });
    }

    async function sendComment(id) {
        const val = document.getElementById(`in-${id}`).value;
        if(!val) return;
        await db.collection("posts").doc(id).update({
            comments: firebase.firestore.FieldValue.arrayUnion({ userId: user.id, userName: user.name, text: val, time: Date.now() })
        });
        document.getElementById(`in-${id}`).value = "";
    }

    function addCourseRow() {
        const div = document.createElement('div');
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<input type="text" class="form-input" style="flex:2; margin:0;" placeholder="Course"><input type="number" class="c-unit form-input" style="flex:1; margin:0;" placeholder="Unit"><select class="c-grade form-input" style="flex:1; margin:0;"><option value="4.0">A</option><option value="3.5">AB</option><option value="3.25">B</option><option value="3.0">BC</option><option value="2.75">C</option><option value="0.0">F</option></select>`;
        document.getElementById('course-list').appendChild(div);
    }

    function calculateGP() {
        let tp = 0, tu = 0;
        document.querySelectorAll('.c-unit').forEach((u, i) => {
            const unit = parseFloat(u.value);
            if(unit > 0) { tp += (unit * parseFloat(document.querySelectorAll('.c-grade')[i].value)); tu += unit; }
        });
        document.getElementById('gp-res').innerText = tu > 0 ? (tp/tu).toFixed(2) : "0.00";
    }

    function renderChatList() {
        db.collection("users").onSnapshot(snap => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.id !== user.id) list.innerHTML += `<div class="elite-card" onclick="openChat('${u.id}', '${u.name}')"><b>${u.name}</b><br><small>${u.role}</small></div>`;
            });
        });
    }

    function openChat(tid, tname) {
        activeChatId = tid;
        document.getElementById('chat-target').innerText = tname;
        document.getElementById('chat-drawer').classList.remove('hidden');
        const rid = [user.id, tid].sort().join('_');
        if(activeChatListener) activeChatListener();
        activeChatListener = db.collection("chats").doc(rid).collection("m").orderBy("time", "asc").onSnapshot(snap => {
            const cont = document.getElementById('chat-msgs');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data();
                cont.innerHTML += `<div class="chat-bubble ${m.sid === user.id ? 'sent' : 'received'}">${m.t}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    async function sendMsg() {
        const val = document.getElementById('msg-input').value;
        if(!val) return;
        const rid = [user.id, activeChatId].sort().join('_');
        await db.collection("chats").doc(rid).collection("m").add({ sid: user.id, t: val, time: firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById('msg-input').value = "";
    }

    function closeChat() { document.getElementById('chat-drawer').classList.add('hidden'); }

    function switchTab(t) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        if(t === 'profile') updateProfileStats();
        lucide.createIcons();
    }

    async function updateProfileStats() {
        const posts = await db.collection("posts").where("uid", "==", user.id).get();
        document.getElementById('p-name').innerText = user.name;
        document.getElementById('p-role').innerText = user.role;
        document.getElementById('p-img').src = user.pic;
        document.getElementById('p-matric-display').innerText = "ID: " + user.matric;
        document.getElementById('stat-posts').innerText = posts.size;
        document.getElementById('stat-gp').innerText = document.getElementById('gp-res').innerText;
    }

    function handleMarketFile(input) {
        const reader = new FileReader();
        reader.onload = (e) => { 
            verifiedMediaUrl = e.target.result; 
            document.getElementById('market-progress').innerText = "‚úÖ Image Added";
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function publishMarketItem() {
        const name = document.getElementById('market-item-name').value;
        const price = document.getElementById('market-item-price').value;
        if(!name || !price) return alert("Enter details");
        await db.collection("marketplace").add({
            sellerId: user.id, sellerName: user.name, sellerPic: user.pic,
            itemName: name, itemPrice: price, itemDesc: document.getElementById('market-item-desc').value,
            file: verifiedMediaUrl, time: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('market-item-name').value = "";
        document.getElementById('market-item-price').value = "";
        document.getElementById('market-item-desc').value = "";
        verifiedMediaUrl = "";
        document.getElementById('market-progress').innerText = "";
    }

    function renderMarketplace() {
        db.collection("marketplace").orderBy("time", "desc").onSnapshot(snap => {
            const m = document.getElementById('market-display');
            m.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                m.innerHTML += `
                    <div class="elite-card">
                        <div style="display:flex; justify-content:space-between;">
                            <b style="color:var(--gold);">${d.itemName}</b>
                            <span class="price-tag">‚Ç¶${d.itemPrice}</span>
                        </div>
                        ${d.file ? `<img src="${d.file}" class="post-media">` : ''}
                        <p style="font-size:0.75rem; margin:10px 0;">${d.itemDesc}</p>
                        <button class="btn-luxury" onclick="openChat('${d.sellerId}', '${d.sellerName}')">Contact Seller</button>
                    </div>`;
            });
        });
    }

    async function openPublicProfile(uid) {
        const doc = await db.collection("users").doc(uid).get();
        if(!doc.exists) return;
        const d = doc.data();
        document.getElementById('view-p-img').src = d.pic;
        document.getElementById('view-p-name').innerText = d.name;
        document.getElementById('view-p-role').innerText = d.role;
        document.getElementById('view-p-matric').innerText = "ID: " + d.matric;
        document.getElementById('view-p-chat-btn').onclick = () => { closePublicProfile(); openChat(d.id, d.name); };
        document.getElementById('public-profile-modal').classList.remove('hidden');
    }

    function closePublicProfile() { document.getElementById('public-profile-modal').classList.add('hidden'); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
